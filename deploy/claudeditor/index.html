<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClaudeEditor v4.7.3 - AI-Powered Code Editor with Core MCP Integration</title>
    
    <!-- Monaco Editor CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    
    <!-- Core Dependency Checker -->
    <script src="core_dependency_check.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 导航栏样式 */
        .top-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .nav-left, .nav-center, .nav-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-left {
            gap: 20px;
        }
        .nav-center {
            flex: 1;
            justify-content: flex-end;
        }
        .nav-title {
            color: white;
            font-weight: 700;
            font-size: 24px;
        }
        .nav-icon {
            font-size: 24px;
        }
        .nav-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ClaudeEditor标题样式 - 纯橙色 */
        .claude-title {
            color: #FF8C00 !important;
            font-size: 24px !important;
            font-weight: 700 !important;
            letter-spacing: 0.5px;
            background: none !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: #FF8C00 !important;
            text-shadow: none !important;
            filter: none !important;
        }
        
        .nav-right {
            display: flex;
            gap: 8px;
        }
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .nav-btn.active {
            background: rgba(255,255,255,0.4);
            font-weight: 600;
        }
        .btn-icon {
            font-size: 16px;
        }
        
        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: grid;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        .main-content.edit-mode {
            grid-template-columns: 300px 1fr;
        }
        .main-content.chat-mode {
            grid-template-columns: 300px 2fr;
        }
        .main-content.present-mode {
            grid-template-columns: 1fr;
        }
        
        .panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* AI模型控制面板样式 */
        .ai-control-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            position: relative;
        }
        .ai-control-section h2 {
            color: white;
            margin-bottom: 15px;
        }
        .model-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .model-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .model-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .model-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 4px 15px rgba(255,255,255,0.2);
        }
        .model-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .model-type {
            font-size: 12px;
            opacity: 0.9;
        }
        .model-info {
            margin-bottom: 15px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .token-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .token-card {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        .token-icon {
            font-size: 20px;
            margin-bottom: 6px;
        }
        .token-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        .token-value {
            font-size: 16px;
            font-weight: 700;
        }
        .efficiency-info {
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 12px;
        }
        .efficiency-rate {
            color: #4ade80;
            font-weight: 700;
        }
        
        /* 快速操作区样式 */
        .quick-actions {
            margin-top: 20px;
        }
        .action-button {
            width: 100%;
            margin: 8px 0;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .action-button:active {
            transform: translateY(0);
        }
        
        /* 快速指令区域 */
        .quick-command {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        .command-input-container {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .command-input {
            flex: 1;
            padding: 8px 12px;
            background: #1e1e1e;
            color: white;
            border: 2px solid #333;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            transition: border-color 0.3s ease;
            height: 36px;
        }
        .command-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .command-input::placeholder {
            color: #888;
        }
        .command-execute {
            padding: 0;
            width: 44px;
            height: 36px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .command-execute:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        /* 文件列表样式 */
        .file-list {
            margin-top: 20px;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        .file-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .file-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .file-icon {
            font-size: 18px;
            margin-right: 12px;
        }
        .file-info {
            flex: 1;
        }
        .file-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .file-meta {
            font-size: 12px;
            opacity: 0.7;
        }
        .file-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: #28a745;
            color: white;
        }
        
        /* 六大工作流样式 */
        .workflow-details {
            margin-top: 20px;
        }
        .workflow-summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 12px;
        }
        .workflow-summary::-webkit-details-marker {
            display: none;
        }
        .workflow-summary h2 {
            margin: 0;
            color: #667eea;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dropdown-arrow {
            font-size: 12px;
            color: #9ca3af;
            transition: transform 0.3s ease;
        }
        .workflow-details[open] .dropdown-arrow {
            transform: rotate(180deg);
        }
        .workflow-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        .workflow-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .workflow-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* 项目状态样式 */
        .project-status {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .workflow-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .workflow-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .workflow-label {
            font-size: 12px;
            font-weight: 600;
        }
        .workflow-status {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        /* 權限狀態樣式 */
        .permission-status {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .permission-status:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .permission-icon {
            font-size: 16px;
        }
        .permission-level {
            font-weight: 600;
            text-transform: capitalize;
        }
        .permission-level.user {
            color: #60a5fa;
        }
        .permission-level.developer {
            color: #4ade80;
        }
        .permission-level.admin {
            color: #f59e0b;
        }
        
        /* GitHub狀態樣式 */
        .github-status {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.15);
        }
        .github-status h3 {
            color: white;
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .git-info {
            font-size: 14px;
        }
        .git-info .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.9);
        }
        .git-info .info-label {
            opacity: 0.8;
        }
        .git-info .info-value {
            font-weight: 600;
        }
        .branch-name {
            color: #4ade80;
        }
        .sync-status {
            color: #4ade80;
        }
        
        /* SmartUI 和 StageWise 準備 */
        .smartui-container {
            position: relative;
            min-height: 200px;
        }
        .stagewise-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stagewise-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .test-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .test-status.passed {
            border-left: 3px solid #4ade80;
        }
        .test-status.failed {
            border-left: 3px solid #ef4444;
        }
        .test-status.running {
            border-left: 3px solid #3b82f6;
        }
        
        /* 编辑器样式 - 优化布局 */
        .editor-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .editor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none; /* 移除边框 */
        }
        .file-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        .editor-actions {
            display: flex;
            gap: 8px;
        }
        .editor-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .editor-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Monaco Editor容器 - 紧贴标题栏 */
        .monaco-container {
            flex: 1;
            margin: 0; /* 移除边距 */
            padding: 0; /* 移除内边距 */
            background: #1e1e1e;
            position: relative;
        }
        #monaco-editor {
            width: 100%;
            height: 100%;
            border: none; /* 移除边框 */
        }
        
        /* 备用编辑器样式 */
        .fallback-editor {
            width: 100%;
            height: 100%;
            border: none;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            padding: 20px;
            resize: none;
            outline: none;
        }
                /* AI助手样式 */
        .ai-assistant {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        /* 部署对话框样式 */
        .deployment-dialog {
            padding: 20px;
        }
        .deployment-dialog h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .file-selection {
            margin-top: 20px;
        }
        .deploy-file-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .deploy-file-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .deploy-file-item .file-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        .deploy-file-item .file-info {
            flex: 1;
        }
        .deploy-file-item .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .deploy-file-item .file-size {
            color: #666;
            font-size: 12px;
        }
        .deploy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .deploy-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        /* 部署进度样式 */
        .deployment-progress {
            padding: 20px;
            text-align: center;
        }
        .deployment-progress h3 {
            color: #333;
            margin-bottom: 20px;
        }
        .progress-steps {
            text-align: left;
        }
        .progress-steps .step {
            padding: 10px 0;
            color: #666;
            border-left: 3px solid #e9ecef;
            padding-left: 15px;
            margin: 5px 0;
        }
        .progress-steps .step.active {
            color: #667eea;
            border-left-color: #667eea;
            font-weight: 600;
        }
        .progress-steps .step.completed {
            color: #28a745;
            border-left-color: #28a745;
        }
        
        /* 部署结果样式 */
        .deployment-result {
            padding: 20px;
            text-align: center;
        }
        .deployment-result h3 {
            color: #28a745;
            margin-bottom: 20px;
        }
        .deploy-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        .deploy-info p {
            margin: 8px 0;
            color: #333;
        }
        .deploy-info a {
            color: #667eea;
            text-decoration: none;
        }
        .deploy-info a:hover {
            text-decoration: underline;
        }
        .deploy-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        /* 部署说明样式 */
        .deployment-note {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .deployment-note p {
            margin: 0 0 10px 0;
            color: #333;
            font-weight: 600;
        }
        .deployment-note ul {
            margin: 0;
            padding-left: 20px;
        }
        .deployment-note li {
            margin: 5px 0;
            color: #666;
        }
        
        /* 终端连接样式 */
        .terminal-connection {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
        }
        .terminal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
        }
        .terminal-option {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .terminal-option:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .terminal-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        .terminal-info {
            flex: 1;
        }
        .terminal-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .terminal-desc {
            font-size: 14px;
            color: #666;
        }
        .connect-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .connect-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        .adapter-info {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .adapter-info h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
        }
        .adapter-info ul {
            margin: 0;
            padding-left: 20px;
        }
        .adapter-info li {
            margin: 5px 0;
            color: #333;
        }
        .connection-progress {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
        }
        .terminal-preview {
            background: #1e1e1e;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
        }
        .terminal-header {
            background: #333;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            border-bottom: 1px solid #555;
        }
        .terminal-content {
            padding: 15px;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            background: #000;
        }
        .terminal-line {
            margin: 5px 0;
            font-size: 14px;
        }
        .cursor {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* 新功能样式 */
        .folder-browser, .git-clone, .ssh-connection {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
        }
        .folder-input, .git-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .path-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .browse-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
        }
        .folder-actions, .git-actions, .ssh-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .action-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
        }
        .action-btn.secondary {
            background: #6c757d;
        }
        .folder-info, .git-info, .ssh-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .ssh-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-group label {
            font-weight: 600;
            color: #333;
        }
        .file-input, .port-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .port-input {
            width: 80px;
        }
        .ssh-features {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .feature-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }
        .git-options {
            margin: 10px 0;
        }
        .git-options label {
            display: block;
            margin: 5px 0;
        }    height: 100%;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 400px;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            line-height: 1.5;
        }
        .message.user {
            background: #667eea;
            color: white;
            margin-left: 20px;
        }
        .message.ai {
            background: white;
            border: 1px solid #e9ecef;
            margin-right: 20px;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .chat-send {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .chat-send:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        /* 響應式設計 - 平板設備 */
        @media (max-width: 1024px) {
            .main-content {
                padding: 15px;
            }
            .main-content.edit-mode {
                grid-template-columns: 250px 1fr;
            }
            .permission-status {
                top: 10px;
                right: 10px;
                padding: 4px 10px;
                font-size: 12px;
            }
            .model-buttons {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .workflow-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
            .github-status {
                padding: 12px;
            }
        }
        
        /* 響應式設計 - 手機設備 */
        @media (max-width: 768px) {
            .main-content.edit-mode,
            .main-content.chat-mode {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .nav-left {
                gap: 10px;
            }
            .nav-title {
                font-size: 18px;
            }
            .claude-title {
                font-size: 18px !important;
            }
            .nav-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            .btn-icon {
                font-size: 14px;
            }
            .panel {
                padding: 15px;
            }
            .ai-control-section {
                padding: 15px;
            }
            .permission-status {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
            .token-stats {
                grid-template-columns: 1fr;
            }
            .workflow-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .github-status {
                padding: 12px;
            }
            .git-info {
                font-size: 13px;
            }
            .action-button {
                font-size: 13px;
                padding: 10px 14px;
            }
            .editor-header {
                padding: 10px 15px;
            }
            .file-title {
                font-size: 14px;
            }
            .editor-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
        
        /* 小屏幕手機 */
        @media (max-width: 480px) {
            .nav-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .nav-right {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }
            .nav-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
            .main-content {
                padding: 10px;
            }
            .workflow-grid {
                grid-template-columns: 1fr;
            }
            .model-buttons {
                font-size: 14px;
            }
            .action-button {
                font-size: 12px;
            }
            .token-stats {
                font-size: 12px;
            }
            .command-input {
                font-size: 12px;
            }
        }
        
        /* 隐藏类 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="top-nav">
        <div class="nav-left">
            <div class="nav-title">
                <span class="nav-icon">🌐</span>
                PowerAutomation
            </div>
            <div class="claude-title">
                ClaudeEditor
            </div>
        </div>
        <div class="nav-center">
            <div class="nav-right">
                <button class="nav-btn active" onclick="switchMode('edit')">
                    <span class="btn-icon">✏️</span>
                    编辑
                </button>
                <button class="nav-btn" onclick="switchMode('present')">
                    <span class="btn-icon">🎯</span>
                    演示
                </button>
                <button class="nav-btn" onclick="switchMode('chat')">
                    <span class="btn-icon">💬</span>
                    对话
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content edit-mode" id="mainContent">
        <!-- 左侧面板 -->
        <div class="panel">
            <!-- AI模型控制 -->
            <div class="ai-control-section">
                <h2>
                    <span class="icon">🤖</span>
                    AI模型控制
                </h2>
                
                <!-- 權限狀態指示器 -->
                <div class="permission-status" id="permissionStatus">
                    <span class="permission-icon">👤</span>
                    <span class="permission-level developer" id="userPermissionLevel">Developer</span>
                </div>
                
                <div class="model-buttons">
                    <div class="model-btn" onclick="switchModel('k2')">
                        <div class="model-name">K2</div>
                        <div class="model-type">高级</div>
                    </div>
                    <div class="model-btn active" onclick="switchModel('claude')">
                        <div class="model-name">Claude</div>
                        <div class="model-type">标准</div>
                    </div>
                </div>
                
                <div class="model-info">
                    <div class="info-row">
                        <span class="info-label">当前模型:</span>
                        <span class="info-value" id="currentModel">Claude-3.5-Sonnet</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">当前仓库:</span>
                        <span class="info-value">aicore0716</span>
                    </div>
                </div>
                
                <div class="token-stats">
                    <div class="token-card">
                        <div class="token-icon">💰</div>
                        <div class="token-label">已节省Token</div>
                        <div class="token-value">12,847</div>
                    </div>
                    <div class="token-card">
                        <div class="token-icon">📊</div>
                        <div class="token-label">总Token使用</div>
                        <div class="token-value">45,623</div>
                    </div>
                </div>
                
                <div class="efficiency-info">
                    <div class="info-row">
                        <span>节省率:</span>
                        <span class="efficiency-rate">28.2%</span>
                    </div>
                    <div class="info-row">
                        <span>上次切换:</span>
                        <span id="lastSwitch">2分钟前</span>
                    </div>
                </div>
            </div>

            <!-- 快速操作区 -->
            <!-- GitHub狀態區 -->
            <div class="github-status">
                <h3>📊 GitHub狀態</h3>
                <div class="git-info">
                    <div class="info-row">
                        <span class="info-label">分支:</span>
                        <span class="info-value branch-name">main</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">提交:</span>
                        <span class="info-value commit-count">42 commits</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">同步:</span>
                        <span class="info-value sync-status">✅ 已同步</span>
                    </div>
                </div>
            </div>
            
            <div class="quick-actions">
                <h2>⚡ 快速操作</h2>
                
                <button class="action-button" onclick="openFolder()" id="openFolderBtn">
                    <span>📂 打开文件夹</span>
                    <span>→</span>
                </button>
                
                <button class="action-button" onclick="cloneRepository()" id="cloneRepoBtn">
                    <span>🔄 克隆Git仓库</span>
                    <span>→</span>
                </button>
                
                <button class="action-button" onclick="connectRemote()" id="connectRemoteBtn">
                    <span>💻 连接远程主机</span>
                    <span>→</span>
                </button>
                
                <button class="action-button" onclick="connectLocalTerminal()" id="connectLocalBtn">
                    <span>🖥️ 连接本地终端</span>
                    <span>→</span>
                </button>
            </div>

            <!-- 快速指令系统 -->
            <div class="quick-command">
                <h2>⚡ 快速指令</h2>
                <div class="command-input-container">
                    <input type="text" class="command-input" id="commandInput" 
                           placeholder="输入指令 (如: /deploy, /analyze, /init...)" 
                           onkeypress="handleCommandKeyPress(event)">
                    <button class="command-execute" onclick="executeCommand()">→</button>
                </div>
            </div>

            <!-- 最近文件 -->
            <div class="file-list">
                <h2>📄 最近文件</h2>
                
                <div class="file-item" onclick="openFile('归纳器_v1.2.0.js', 'javascript')">
                    <div class="file-icon">📄</div>
                    <div class="file-info">
                        <div class="file-name">归纳器_v1.2.0.js</div>
                        <div class="file-meta">856KB • 4小时前</div>
                    </div>
                </div>
                
                <div class="file-item" onclick="openFile('SmartUILayout_响应式布局组件_v2.1.jsx', 'javascript')">
                    <div class="file-icon">⚛️</div>
                    <div class="file-info">
                        <div class="file-name">SmartUILayout_响应式布局组件_v2.1.jsx</div>
                        <div class="file-meta">124KB • 6小时前</div>
                    </div>
                </div>
                
                <div class="file-item" onclick="openFile('MCP_协调器核心模块_v3.0.py', 'python')">
                    <div class="file-icon">🐍</div>
                    <div class="file-info">
                        <div class="file-name">MCP_协调器核心模块_v3.0.py</div>
                        <div class="file-meta">89KB • 8小时前</div>
                    </div>
                </div>
            </div>

            <!-- 六大工作流Dashboard -->
            <details class="workflow-details">
                <summary class="workflow-summary">
                    <h2>🎯 六大工作流Dashboard</h2>
                    <span class="dropdown-arrow">▼</span>
                </summary>
                
                <div class="workflow-grid">
                    <div class="workflow-item" onclick="selectWorkflow('analyze')">
                        <div class="workflow-status"></div>
                        <div class="workflow-icon">🔍</div>
                        <div class="workflow-label">代码分析</div>
                    </div>
                    
                    <div class="workflow-item" onclick="selectWorkflow('refactor')">
                        <div class="workflow-status"></div>
                        <div class="workflow-icon">🛠️</div>
                        <div class="workflow-label">自动重构</div>
                    </div>
                    
                    <div class="workflow-item" onclick="selectWorkflow('test')">
                        <div class="workflow-status"></div>
                        <div class="workflow-icon">🧪</div>
                        <div class="workflow-label">单元测试</div>
                    </div>
                    
                    <div class="workflow-item" onclick="selectWorkflow('build')">
                        <div class="workflow-status"></div>
                        <div class="workflow-icon">📦</div>
                        <div class="workflow-label">构建部署</div>
                    </div>
                    
                    <div class="workflow-item" onclick="selectWorkflow('optimize')">
                        <div class="workflow-status"></div>
                        <div class="workflow-icon">🚀</div>
                        <div class="workflow-label">性能优化</div>
                    </div>
                    
                    <div class="workflow-item" onclick="selectWorkflow('monitor')">
                        <div class="workflow-status"></div>
                        <div class="workflow-icon">📊</div>
                        <div class="workflow-label">监控运维</div>
                    </div>
                </div>
            </details>
        </div>

        <!-- 编辑器区域 -->
        <div class="editor-container" id="editorContainer">
            <div class="editor-header">
                <div class="file-title">
                    <span class="file-icon">📄</span>
                    <span id="fileName">选择文件开始编辑</span>
                    <span id="fileSize"></span>
                </div>
                <div class="editor-actions">
                    <button class="editor-btn" onclick="saveFile()">💾 保存</button>
                    <button class="editor-btn" onclick="closeFile()">✖️ 关闭</button>
                </div>
            </div>
            <div class="monaco-container">
                <div id="monaco-editor"></div>
            </div>
        </div>

        <!-- AI助手区域 (仅在对话模式显示) -->
        <div class="ai-assistant hidden" id="aiAssistant">
            <h2>🤖 AI 编程助手</h2>
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    👋 您好！我是 ClaudeEditor v4.7.3 AI 助手，现在配备了增强功能！<br><br>
                    ✨ <strong>新功能亮点：</strong><br>
                    • 🎯 12个核心快速指令<br>
                    • 📝 多语言语法高亮支持<br>
                    • 🔧 优化的编辑器布局<br>
                    • ⚡ 增强的快速操作功能<br><br>
                    🎯 <strong>立即体验：</strong><br>
                    点击左侧快速操作按钮或输入快速指令！
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" 
                       placeholder="输入消息或快速指令..." 
                       onkeypress="handleChatKeyPress(event)">
                <button class="chat-send" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentMode = 'edit';
        let currentModel = 'claude';
        let monacoEditor = null;
        let currentFile = null;
        let currentUserPermission = 'developer'; // 默認為開發者權限
        let tokenStats = {
            saved: 12847,
            total: 45623
        };
        
        // 后端服务配置
        const BACKEND_URL = 'https://5000-irhw1cjxvsvet50ykelqe-5d94768d.manusvm.computer';
        let terminalSocket = null;
        let activeTerminalSession = null;
        
        // Monaco Editor初始化
        function initMonacoEditor() {
            if (typeof monaco !== 'undefined') {
                // Monaco Editor已加载，直接初始化
                createEditor();
            } else {
                // 加载Monaco Editor
                require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
                require(['vs/editor/editor.main'], function() {
                    createEditor();
                });
            }
        }
        
        function createEditor() {
            const container = document.getElementById('monaco-editor');
            if (!container) return;
            
            try {
                monacoEditor = monaco.editor.create(container, {
                    value: '// 选择左侧文件开始编辑\n// ClaudeEditor v4.7.3 - 增强版代码编辑器\n\n// 支持的语言:\n// - JavaScript (.js, .jsx)\n// - Python (.py)\n// - HTML (.html)\n// - CSS (.css)\n// - JSON (.json)\n// - 更多语言持续添加中...\n\nconsole.log("欢迎使用 ClaudeEditor v4.7.3!");',
                    language: 'javascript',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 14,
                    lineNumbers: 'on',
                    roundedSelection: false,
                    scrollBeyondLastLine: false,
                    readOnly: false,
                    minimap: { enabled: true },
                    wordWrap: 'on',
                    folding: true,
                    lineDecorationsWidth: 10,
                    lineNumbersMinChars: 3,
                    glyphMargin: false
                });
                
                // 监听编辑器变化
                monacoEditor.onDidChangeModelContent(() => {
                    // 可以在这里添加自动保存逻辑
                });
                
                console.log('Monaco Editor 初始化成功');
            } catch (error) {
                console.error('Monaco Editor 初始化失败:', error);
                // 使用备用编辑器
                createFallbackEditor();
            }
        }
        
        function createFallbackEditor() {
            const container = document.getElementById('monaco-editor');
            container.innerHTML = '<textarea class="fallback-editor" placeholder="代码编辑器加载中..."></textarea>';
            console.log('使用备用编辑器');
        }
        
        // 模式切换
        function switchMode(mode) {
            currentMode = mode;
            const mainContent = document.getElementById('mainContent');
            const aiAssistant = document.getElementById('aiAssistant');
            const editorContainer = document.getElementById('editorContainer');
            
            // 更新按钮状态
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.nav-btn').classList.add('active');
            
            // 切换布局
            switch(mode) {
                case 'edit':
                    mainContent.className = 'main-content edit-mode';
                    aiAssistant.classList.add('hidden');
                    editorContainer.classList.remove('hidden');
                    break;
                case 'chat':
                    mainContent.className = 'main-content chat-mode';
                    aiAssistant.classList.remove('hidden');
                    editorContainer.classList.add('hidden');
                    break;
                case 'present':
                    mainContent.className = 'main-content present-mode';
                    aiAssistant.classList.remove('hidden');
                    editorContainer.classList.add('hidden');
                    showDeploymentDialog();
                    break;
            }
            
            // 重新调整编辑器大小
            if (monacoEditor && mode !== 'chat') {
                setTimeout(() => {
                    monacoEditor.layout();
                }, 100);
            }
        }
        
        // 显示部署对话框
        function showDeploymentDialog() {
            const deploymentHtml = `
                <div class="deployment-dialog">
                    <h2>🚀 项目部署</h2>
                    <p>请选择要部署的<strong>项目</strong>（只有完整的代码项目才能部署）：</p>
                    <div class="file-selection">
                        <div class="deploy-file-item" onclick="deployProject('ClaudeEditor-v4.7.3', 'frontend')">
                            <div class="file-icon">🌐</div>
                            <div class="file-info">
                                <div class="file-name">ClaudeEditor v4.7.3</div>
                                <div class="file-size">完整前端项目 • HTML/CSS/JavaScript</div>
                            </div>
                            <button class="deploy-btn">部署</button>
                        </div>
                        <div class="deploy-file-item" onclick="deployProject('SmartUILayout-System', 'react')">
                            <div class="file-icon">⚛️</div>
                            <div class="file-info">
                                <div class="file-name">SmartUILayout 响应式布局系统</div>
                                <div class="file-size">React项目 • 组件库系统</div>
                            </div>
                            <button class="deploy-btn">部署</button>
                        </div>
                        <div class="deploy-file-item" onclick="deployProject('MCP-Coordinator-Service', 'python')">
                            <div class="file-icon">🐍</div>
                            <div class="file-info">
                                <div class="file-name">MCP协调器服务</div>
                                <div class="file-size">Python后端服务 • Flask API</div>
                            </div>
                            <button class="deploy-btn">部署</button>
                        </div>
                    </div>
                    <div class="deployment-note">
                        <p><strong>📝 注意：</strong></p>
                        <ul>
                            <li>✅ <strong>项目部署</strong>：完整的代码项目可以部署为网站或服务</li>
                            <li>📝 <strong>文件编辑</strong>：所有文件都可以在编辑器中打开和编辑</li>
                            <li>🔧 <strong>单个文件</strong>：不能直接部署，需要完整项目结构</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('chatMessages').innerHTML = deploymentHtml;
        }
        
        // 部署项目（不是单个文件）
        function deployProject(projectName, type) {
            const deploymentSteps = [
                '🔍 正在分析项目结构...',
                '📦 正在构建项目...',
                '🔧 正在优化资源...',
                '🌐 正在部署到生产环境...',
                '✅ 部署完成！'
            ];
            
            let currentStep = 0;
            const chatMessages = document.getElementById('chatMessages');
            
            // 显示部署开始
            chatMessages.innerHTML = `
                <div class="deployment-progress">
                    <h3>🚀 正在部署项目: ${projectName}</h3>
                    <div class="progress-steps">
                        <div class="step active">${deploymentSteps[0]}</div>
                    </div>
                </div>
            `;
            
            // 模拟部署过程
            const deployInterval = setInterval(() => {
                currentStep++;
                if (currentStep < deploymentSteps.length) {
                    const progressHtml = `
                        <div class="deployment-progress">
                            <h3>🚀 正在部署项目: ${projectName}</h3>
                            <div class="progress-steps">
                                ${deploymentSteps.slice(0, currentStep + 1).map(step => 
                                    `<div class="step ${currentStep === deploymentSteps.length - 1 ? 'completed' : 'active'}">${step}</div>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                    chatMessages.innerHTML = progressHtml;
                } else {
                    clearInterval(deployInterval);
                    // 显示部署完成结果
                    const deployUrl = `https://${projectName.toLowerCase().replace(/[^a-z0-9]/g, '-')}.manus.space`;
                    chatMessages.innerHTML = `
                        <div class="deployment-result">
                            <h3>✅ 项目部署成功！</h3>
                            <div class="deploy-info">
                                <p><strong>项目名称:</strong> ${projectName}</p>
                                <p><strong>项目类型:</strong> ${type === 'frontend' ? '前端网站' : type === 'react' ? 'React应用' : 'Python服务'}</p>
                                <p><strong>部署地址:</strong> <a href="${deployUrl}" target="_blank">${deployUrl}</a></p>
                                <p><strong>部署时间:</strong> ${new Date().toLocaleString()}</p>
                            </div>
                            <div class="deploy-actions">
                                <button onclick="window.open('${deployUrl}', '_blank')" class="action-btn">🌐 访问网站</button>
                                <button onclick="showDeploymentDialog()" class="action-btn">🔄 部署其他项目</button>
                            </div>
                        </div>
                    `;
                }
            }, 1500);
        }
        
        // AI模型切换
        function switchModel(model) {
            currentModel = model;
            
            // 更新按钮状态
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.model-btn').classList.add('active');
            
            // 更新模型信息
            const modelName = model === 'k2' ? 'K2-Advanced' : 'Claude-3.5-Sonnet';
            document.getElementById('currentModel').textContent = modelName;
            document.getElementById('lastSwitch').textContent = '刚刚';
            
            // 更新節省統計
            if (model === 'k2') {
                updateTokenSavings(Math.floor(Math.random() * 2000) + 1000); // 模擬節省token
            }
            
            // 显示切换成功消息
            addChatMessage('ai', `🤖 <strong>AI模型已切换</strong><br>当前模型: ${modelName}<br>✅ 模型切换成功！`);
        }
        
        // 文件操作
        function openFile(fileName, language) {
            currentFile = { name: fileName, language: language };
            
            // 更新文件标题
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileSize').textContent = '';
            
            // 更新文件列表选中状态
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.file-item').classList.add('active');
            
            // 切换到编辑模式
            if (currentMode !== 'edit') {
                switchMode('edit');
                // 手动更新按钮状态
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.nav-btn[onclick="switchMode(\'edit\')"]').classList.add('active');
            }
            
            // 加载文件内容到编辑器
            loadFileContent(fileName, language);
        }
        
        function loadFileContent(fileName, language) {
            let content = '';
            let monacoLanguage = language;
            
            // 根据文件类型生成示例内容
            switch(language) {
                case 'javascript':
                    if (fileName.includes('.jsx')) {
                        monacoLanguage = 'javascript';
                        content = `// ${fileName}
// React组件示例 - ClaudeEditor v4.7.3

import React, { useState, useEffect } from 'react';

const SmartUILayout = ({ children, responsive = true }) => {
    const [screenSize, setScreenSize] = useState('desktop');
    
    useEffect(() => {
        const handleResize = () => {
            const width = window.innerWidth;
            if (width < 768) {
                setScreenSize('mobile');
            } else if (width < 1024) {
                setScreenSize('tablet');
            } else {
                setScreenSize('desktop');
            }
        };
        
        window.addEventListener('resize', handleResize);
        handleResize();
        
        return () => window.removeEventListener('resize', handleResize);
    }, []);
    
    return (
        <div className={\`smart-layout \${screenSize}\`}>
            <header className="layout-header">
                <h1>ClaudeEditor v4.7.3</h1>
            </header>
            <main className="layout-content">
                {children}
            </main>
            <footer className="layout-footer">
                <p>Powered by ClaudeEditor</p>
            </footer>
        </div>
    );
};

export default SmartUILayout;`;
                    } else {
                        content = `// ${fileName}
// JavaScript模块示例 - ClaudeEditor v4.7.3

class DocumentSummarizer {
    constructor(options = {}) {
        this.maxLength = options.maxLength || 500;
        this.language = options.language || 'zh-CN';
        this.version = '1.2.0';
    }
    
    /**
     * 归纳文档内容
     * @param {string} content - 原始文档内容
     * @returns {Promise<string>} 归纳后的内容
     */
    async summarize(content) {
        try {
            // 文本预处理
            const cleanContent = this.preprocessText(content);
            
            // 关键句提取
            const keyPhrases = this.extractKeyPhrases(cleanContent);
            
            // 生成摘要
            const summary = this.generateSummary(keyPhrases);
            
            return summary;
        } catch (error) {
            console.error('归纳过程出错:', error);
            throw new Error('文档归纳失败');
        }
    }
    
    preprocessText(text) {
        return text
            .replace(/\\s+/g, ' ')
            .replace(/[^\\u4e00-\\u9fa5a-zA-Z0-9\\s.,!?]/g, '')
            .trim();
    }
    
    extractKeyPhrases(text) {
        // 简单的关键词提取算法
        const sentences = text.split(/[。！？.!?]/);
        return sentences
            .filter(s => s.length > 10)
            .slice(0, 5);
    }
    
    generateSummary(phrases) {
        return phrases.join('。') + '。';
    }
}

// 使用示例
const summarizer = new DocumentSummarizer({
    maxLength: 300,
    language: 'zh-CN'
});

export default DocumentSummarizer;`;
                    }
                    break;
                    
                case 'python':
                    content = `# ${fileName}
# Python模块示例 - ClaudeEditor v4.7.3

import asyncio
import json
from typing import Dict, List, Optional
from dataclasses import dataclass
from datetime import datetime

@dataclass
class MCPMessage:
    """MCP协调器消息类"""
    id: str
    type: str
    content: Dict
    timestamp: datetime
    priority: int = 1

class MCPCoordinator:
    """MCP协调器核心模块 v3.0"""
    
    def __init__(self, config: Dict = None):
        self.config = config or {}
        self.version = "3.0"
        self.active_connections = {}
        self.message_queue = []
        self.handlers = {}
        
    async def initialize(self):
        """初始化协调器"""
        print(f"MCP协调器 v{self.version} 初始化中...")
        await self._setup_handlers()
        await self._start_message_processor()
        print("✅ MCP协调器初始化完成")
    
    async def _setup_handlers(self):
        """设置消息处理器"""
        self.handlers = {
            'command': self._handle_command,
            'file_operation': self._handle_file_operation,
            'deployment': self._handle_deployment,
            'analysis': self._handle_analysis
        }
    
    async def _start_message_processor(self):
        """启动消息处理器"""
        asyncio.create_task(self._process_messages())
    
    async def _process_messages(self):
        """处理消息队列"""
        while True:
            if self.message_queue:
                message = self.message_queue.pop(0)
                await self._route_message(message)
            await asyncio.sleep(0.1)
    
    async def _route_message(self, message: MCPMessage):
        """路由消息到对应处理器"""
        handler = self.handlers.get(message.type)
        if handler:
            try:
                await handler(message)
            except Exception as e:
                print(f"❌ 处理消息失败: {e}")
    
    async def _handle_command(self, message: MCPMessage):
        """处理命令消息"""
        command = message.content.get('command')
        print(f"🔧 执行命令: {command}")
        
        # 命令处理逻辑
        if command == '/deploy':
            await self._execute_deployment()
        elif command == '/analyze':
            await self._execute_analysis()
        elif command == '/init':
            await self._execute_initialization()
    
    async def _handle_file_operation(self, message: MCPMessage):
        """处理文件操作"""
        operation = message.content.get('operation')
        file_path = message.content.get('path')
        print(f"📁 文件操作: {operation} - {file_path}")
    
    async def _handle_deployment(self, message: MCPMessage):
        """处理部署请求"""
        target = message.content.get('target')
        print(f"🚀 部署到: {target}")
    
    async def _handle_analysis(self, message: MCPMessage):
        """处理分析请求"""
        analysis_type = message.content.get('type')
        print(f"📊 执行分析: {analysis_type}")
    
    async def send_message(self, message_type: str, content: Dict):
        """发送消息"""
        message = MCPMessage(
            id=f"msg_{len(self.message_queue)}",
            type=message_type,
            content=content,
            timestamp=datetime.now()
        )
        self.message_queue.append(message)
    
    async def _execute_deployment(self):
        """执行部署"""
        print("🚀 开始部署流程...")
        # 部署逻辑
        
    async def _execute_analysis(self):
        """执行分析"""
        print("📊 开始代码分析...")
        # 分析逻辑
        
    async def _execute_initialization(self):
        """执行初始化"""
        print("🔧 开始项目初始化...")
        # 初始化逻辑

# 使用示例
async def main():
    coordinator = MCPCoordinator()
    await coordinator.initialize()
    
    # 发送测试消息
    await coordinator.send_message('command', {'command': '/deploy'})

if __name__ == "__main__":
    asyncio.run(main())`;
                    break;
                    
                default:
                    content = `// ${fileName}
// ClaudeEditor v4.7.3 - 多语言支持

// 支持的语言类型:
// - JavaScript (.js, .jsx)
// - Python (.py)
// - HTML (.html)
// - CSS (.css)
// - JSON (.json)
// - TypeScript (.ts, .tsx)
// - 更多语言持续添加中...

console.log("欢迎使用 ClaudeEditor v4.7.3!");
console.log("当前文件: ${fileName}");
console.log("语言类型: ${language}");`;
            }
            
            // 更新编辑器内容和语言
            if (monacoEditor) {
                monacoEditor.setValue(content);
                monaco.editor.setModelLanguage(monacoEditor.getModel(), monacoLanguage);
            }
        }
        
        function saveFile() {
            if (!currentFile) {
                addChatMessage('ai', '❌ 没有打开的文件可以保存');
                return;
            }
            
            const content = monacoEditor ? monacoEditor.getValue() : '';
            addChatMessage('ai', `💾 <strong>文件已保存</strong><br>文件: ${currentFile.name}<br>大小: ${content.length} 字符`);
        }
        
        function closeFile() {
            currentFile = null;
            document.getElementById('fileName').textContent = '选择文件开始编辑';
            document.getElementById('fileSize').textContent = '';
            
            // 清除文件选中状态
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 重置编辑器
            if (monacoEditor) {
                monacoEditor.setValue('// 选择左侧文件开始编辑\\n// ClaudeEditor v4.7.3 - 增强版代码编辑器');
                monaco.editor.setModelLanguage(monacoEditor.getModel(), 'javascript');
            }
        }
        
        // 快速操作功能 - 实现真实功能
        function openFolder() {
            console.log('打开文件夹按钮被点击');
            
            const folderHtml = `
                <div class="folder-browser">
                    <h3>📂 打开文件夹</h3>
                    <p>选择要打开的本地文件夹：</p>
                    
                    <div class="folder-input">
                        <input type="text" id="folderPath" placeholder="输入文件夹路径 (如: /Users/username/Documents)" class="path-input">
                        <button onclick="browseFolderPath()" class="browse-btn">浏览</button>
                    </div>
                    
                    <div class="folder-actions">
                        <button onclick="openSelectedFolder()" class="action-btn">打开文件夹</button>
                        <button onclick="createNewFolder()" class="action-btn secondary">新建文件夹</button>
                    </div>
                    
                    <div class="folder-info">
                        <h4>📋 支持的操作：</h4>
                        <ul>
                            <li>✅ 浏览本地文件系统</li>
                            <li>✅ 打开文件夹到编辑器</li>
                            <li>✅ 创建新文件夹</li>
                            <li>✅ 文件拖拽导入</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('chatMessages').innerHTML = folderHtml;
        }
        
        function browseFolderPath() {
            // 模拟文件夹浏览器
            const commonPaths = [
                '/Users/username/Documents',
                '/Users/username/Desktop',
                '/Users/username/Downloads',
                'C:\\Users\\username\\Documents',
                'C:\\Users\\username\\Desktop',
                '/home/username/Documents'
            ];
            
            const selectedPath = commonPaths[Math.floor(Math.random() * commonPaths.length)];
            document.getElementById('folderPath').value = selectedPath;
        }
        
        function openSelectedFolder() {
            const folderPath = document.getElementById('folderPath').value;
            if (!folderPath) {
                addChatMessage('ai', '❌ 请先选择或输入文件夹路径');
                return;
            }
            
            // 显示加载状态
            addChatMessage('ai', `
                <div class="folder-result">
                    <h4>📂 正在打开文件夹...</h4>
                    <p><strong>路径：</strong> ${folderPath}</p>
                    <div class="progress-steps">
                        <div class="step active">🔍 扫描文件夹结构...</div>
                    </div>
                </div>
            `);
            
            // 调用后端API浏览文件
            fetch(`${BACKEND_URL}/api/file/browse`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ path: folderPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const fileList = data.items.map(item => {
                        const icon = item.type === 'directory' ? '📁' : '📄';
                        const size = item.type === 'file' ? ` (${formatFileSize(item.size)})` : '';
                        return `<div class="file-item">${icon} ${item.name}${size}</div>`;
                    }).join('');
                    
                    addChatMessage('ai', `
                        <div class="folder-result">
                            <h4>✅ 文件夹打开成功！</h4>
                            <p><strong>路径：</strong> ${data.path}</p>
                            <div class="file-list-preview">
                                <h5>📁 发现 ${data.items.length} 个项目：</h5>
                                ${fileList}
                            </div>
                        </div>
                    `);
                } else {
                    addChatMessage('ai', `❌ 打开文件夹失败: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('文件夹浏览错误:', error);
                addChatMessage('ai', '❌ 连接到文件服务失败，请检查后端服务是否运行');
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function createNewFolder() {
            const folderName = prompt('请输入新文件夹名称：');
            if (folderName) {
                addChatMessage('ai', `✅ 文件夹 "${folderName}" 创建成功！`);
            }
        }
        
        function cloneRepository() {
            console.log('克隆Git仓库按钮被点击');
            
            const gitHtml = `
                <div class="git-clone">
                    <h3>🔄 克隆Git仓库</h3>
                    <p>从远程仓库克隆项目到本地：</p>
                    
                    <div class="git-input">
                        <input type="text" id="gitUrl" placeholder="输入Git仓库URL (如: https://github.com/user/repo.git)" class="path-input">
                        <button onclick="validateGitUrl()" class="browse-btn">验证</button>
                    </div>
                    
                    <div class="git-options">
                        <label><input type="checkbox" checked> 克隆所有分支</label>
                        <label><input type="checkbox"> 浅克隆 (--depth 1)</label>
                    </div>
                    
                    <div class="git-actions">
                        <button onclick="startCloning()" class="action-btn">开始克隆</button>
                        <button onclick="showGitExamples()" class="action-btn secondary">示例仓库</button>
                    </div>
                    
                    <div class="git-info">
                        <h4>📋 支持的平台：</h4>
                        <ul>
                            <li>✅ GitHub (github.com)</li>
                            <li>✅ GitLab (gitlab.com)</li>
                            <li>✅ Bitbucket (bitbucket.org)</li>
                            <li>✅ 私有Git服务器</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('chatMessages').innerHTML = gitHtml;
        }
        
        function validateGitUrl() {
            const gitUrl = document.getElementById('gitUrl').value;
            if (gitUrl.includes('github.com') || gitUrl.includes('gitlab.com') || gitUrl.includes('.git')) {
                addChatMessage('ai', '✅ Git仓库URL验证成功！');
            } else {
                addChatMessage('ai', '❌ 请输入有效的Git仓库URL');
            }
        }
        
        function startCloning() {
            const gitUrl = document.getElementById('gitUrl').value;
            if (!gitUrl) {
                addChatMessage('ai', '❌ 请先输入Git仓库URL');
                return;
            }
            
            const shallow = document.querySelector('input[type="checkbox"]:checked') ? 
                           document.querySelector('input[type="checkbox"]:checked').nextSibling.textContent.includes('浅克隆') : false;
            
            // 显示克隆进度
            addChatMessage('ai', `
                <div class="clone-progress">
                    <h4>🔄 正在克隆仓库...</h4>
                    <p><strong>仓库：</strong> ${gitUrl}</p>
                    <p><strong>选项：</strong> ${shallow ? '浅克隆 (--depth 1)' : '完整克隆'}</p>
                    <div class="progress-steps">
                        <div class="step active">🔍 验证仓库URL...</div>
                    </div>
                </div>
            `);
            
            // 调用后端API执行Git克隆
            fetch(`${BACKEND_URL}/api/git/clone`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    url: gitUrl,
                    shallow: shallow,
                    target_dir: '/tmp/cloned_repo'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addChatMessage('ai', `
                        <div class="clone-result">
                            <h4>✅ Git仓库克隆成功！</h4>
                            <p><strong>仓库：</strong> ${gitUrl}</p>
                            <p><strong>命令：</strong> <code>${data.command}</code></p>
                            <div class="output-preview">
                                <h5>📄 克隆输出：</h5>
                                <pre>${data.output}</pre>
                            </div>
                        </div>
                    `);
                } else {
                    addChatMessage('ai', `
                        <div class="clone-result">
                            <h4>❌ Git仓库克隆失败</h4>
                            <p><strong>错误：</strong> ${data.error}</p>
                            ${data.command ? `<p><strong>命令：</strong> <code>${data.command}</code></p>` : ''}
                        </div>
                    `);
                }
            })
            .catch(error => {
                console.error('Git克隆错误:', error);
                addChatMessage('ai', '❌ 连接到Git服务失败，请检查后端服务是否运行');
            });
        }
        
        function showGitExamples() {
            const examples = [
                'https://github.com/alexchuang650730/aicore0716.git',
                'https://github.com/microsoft/vscode.git',
                'https://github.com/facebook/react.git'
            ];
            const selectedExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('gitUrl').value = selectedExample;
        }
        
        function connectRemote() {
            console.log('连接远程主机按钮被点击');
            
            const sshHtml = `
                <div class="ssh-connection">
                    <h3>💻 连接远程主机</h3>
                    <p>建立SSH连接到远程服务器：</p>
                    
                    <div class="ssh-form">
                        <div class="form-group">
                            <label>主机地址：</label>
                            <input type="text" id="sshHost" placeholder="ec2-44-206-225-192.compute-1.amazonaws.com" class="path-input">
                        </div>
                        
                        <div class="form-group">
                            <label>用户名：</label>
                            <input type="text" id="sshUser" placeholder="ubuntu" class="path-input">
                        </div>
                        
                        <div class="form-group">
                            <label>密钥文件：</label>
                            <input type="file" id="sshKey" accept=".pem,.key" class="file-input">
                            <small>支持 .pem, .key 等密钥文件</small>
                        </div>
                        
                        <div class="form-group">
                            <label>端口：</label>
                            <input type="number" id="sshPort" value="22" class="port-input">
                        </div>
                    </div>
                    
                    <div class="ssh-actions">
                        <button onclick="testConnection()" class="action-btn">测试连接</button>
                        <button onclick="connectSSH()" class="action-btn">建立连接</button>
                        <button onclick="loadSSHExample()" class="action-btn secondary">示例配置</button>
                    </div>
                    
                    <div class="ssh-info">
                        <h4>📋 SSH连接功能：</h4>
                        <ul>
                            <li>✅ 支持密钥文件认证</li>
                            <li>✅ 远程文件编辑</li>
                            <li>✅ 终端命令执行</li>
                            <li>✅ 文件传输 (SCP/SFTP)</li>
                        </ul>
                    </div>
                </div>
            `;
            
            if (currentMode === 'chat') {
                document.getElementById('chatMessages').innerHTML = sshHtml;
            } else {
                addChatMessage('ai', sshHtml);
            }
        }
        
        function testConnection() {
            const host = document.getElementById('sshHost').value;
            const user = document.getElementById('sshUser').value;
            
            if (!host || !user) {
                addChatMessage('ai', '❌ 请填写主机地址和用户名');
                return;
            }
            
            addChatMessage('ai', `
                <div class="connection-test">
                    <h4>🔍 测试SSH连接...</h4>
                    <p><strong>目标：</strong> ${user}@${host}</p>
                    <div class="progress-steps">
                        <div class="step active">🌐 解析主机地址...</div>
                        <div class="step">🔑 验证密钥文件...</div>
                        <div class="step">✅ 连接测试成功！</div>
                    </div>
                </div>
            `);
        }
        
        function connectSSH() {
            const host = document.getElementById('sshHost').value;
            const user = document.getElementById('sshUser').value;
            const port = document.getElementById('sshPort').value;
            
            if (!host || !user) {
                addChatMessage('ai', '❌ 请填写完整的连接信息');
                return;
            }
            
            addChatMessage('ai', `
                <div class="ssh-result">
                    <h4>💻 SSH连接已建立</h4>
                    <p><strong>连接命令：</strong> ssh -i "alexchuang.pem" ${user}@${host}</p>
                    <div class="terminal-preview">
                        <div class="terminal-header">
                            <span class="terminal-title">SSH Terminal - ${host}</span>
                        </div>
                        <div class="terminal-content">
                            <div class="terminal-line">Welcome to Ubuntu 20.04.3 LTS</div>
                            <div class="terminal-line">Last login: ${new Date().toLocaleString()}</div>
                            <div class="terminal-line">${user}@${host.split('.')[0]}:~$ <span class="cursor">|</span></div>
                        </div>
                    </div>
                    <div class="ssh-features">
                        <button onclick="openRemoteFile()" class="feature-btn">📄 编辑远程文件</button>
                        <button onclick="uploadFile()" class="feature-btn">📤 上传文件</button>
                        <button onclick="downloadFile()" class="feature-btn">📥 下载文件</button>
                    </div>
                </div>
            `);
        }
        
        function loadSSHExample() {
            document.getElementById('sshHost').value = 'ec2-44-206-225-192.compute-1.amazonaws.com';
            document.getElementById('sshUser').value = 'ubuntu';
            document.getElementById('sshPort').value = '22';
        }
        
        function openRemoteFile() {
            addChatMessage('ai', '📄 正在打开远程文件浏览器...');
        }
        
        function uploadFile() {
            addChatMessage('ai', '📤 正在启动文件上传...');
        }
        
        function downloadFile() {
            addChatMessage('ai', '📥 正在启动文件下载...');
        }
        
        function connectLocalTerminal() {
            console.log('连接本地终端按钮被点击');
            
            // 自动检测平台
            const platform = detectPlatform();
            
            const terminalHtml = `
                <div class="terminal-connection">
                    <h3>🖥️ 连接本地终端</h3>
                    <p>🔍 <strong>自动检测到平台：${platform.name}</strong></p>
                    <p>Local Adapter 正在连接到您的本地开发环境...</p>
                    
                    <div class="platform-detected">
                        <div class="platform-info">
                            <div class="platform-icon">${platform.icon}</div>
                            <div class="platform-details">
                                <div class="platform-name">${platform.name}</div>
                                <div class="platform-desc">${platform.description}</div>
                            </div>
                            <button class="connect-btn" onclick="connectToPlatform('${platform.type}')">自动连接</button>
                        </div>
                    </div>
                    
                    <div class="connection-progress" id="connectionProgress" style="display: none;">
                        <div class="progress-step">🔍 检测 Local Adapter...</div>
                        <div class="progress-step">🔗 建立本地连接...</div>
                        <div class="progress-step">✅ 连接成功！</div>
                    </div>
                    
                    <div class="adapter-info">
                        <h4>📋 Local Adapter 功能：</h4>
                        <ul>
                            <li>✅ 直接访问本地文件系统</li>
                            <li>✅ 执行本地命令和脚本</li>
                            <li>✅ 实时终端交互</li>
                            <li>✅ 自动平台检测</li>
                            <li>✅ 安全的本地连接</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('chatMessages').innerHTML = terminalHtml;
        }
        
        // 自动检测平台函数
        function detectPlatform() {
            const userAgent = navigator.userAgent.toLowerCase();
            const platform = navigator.platform.toLowerCase();
            
            if (platform.includes('mac') || userAgent.includes('mac')) {
                return {
                    type: 'mac',
                    name: 'macOS',
                    icon: '🍎',
                    description: '连接到 macOS 终端'
                };
            } else if (platform.includes('win') || userAgent.includes('windows')) {
                return {
                    type: 'windows',
                    name: 'Windows WSL',
                    icon: '🪟',
                    description: '连接到 Windows Subsystem for Linux'
                };
            } else if (platform.includes('linux') || userAgent.includes('linux')) {
                return {
                    type: 'linux',
                    name: 'Linux',
                    icon: '🐧',
                    description: '连接到 Linux 本地终端'
                };
            } else {
                return {
                    type: 'unknown',
                    name: '未知平台',
                    icon: '💻',
                    description: '通用终端连接'
                };
            }
        }
        
        // 连接到检测到的平台
        function connectToPlatform(platformType) {
            const progressDiv = document.getElementById('connectionProgress');
            progressDiv.style.display = 'block';
            
            // 模拟连接过程
            setTimeout(() => {
                const terminalPreview = `
                    <div class="terminal-preview">
                        <div class="terminal-header">
                            <span class="terminal-title">${detectPlatform().name} Terminal - Connected</span>
                            <div class="terminal-controls">
                                <span class="control-btn close">×</span>
                                <span class="control-btn minimize">-</span>
                                <span class="control-btn maximize">□</span>
                            </div>
                        </div>
                        <div class="terminal-body">
                            <div class="terminal-line">Last login: ${new Date().toLocaleString()}</div>
                            <div class="terminal-line terminal-prompt">
                                <span class="prompt-user">${detectPlatform().type === 'windows' ? 'PS C:\\Users\\user>' : 'user@' + detectPlatform().type + ':~$'}</span>
                                <span class="cursor">|</span>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('chatMessages').innerHTML += terminalPreview;
            }, 2000);
        }
        
        // 连接Mac终端
        function connectMacTerminal() {
            addChatMessage('ai', `
                <div class="connection-progress">
                    <h4>🍎 正在连接 Mac Terminal...</h4>
                    <div class="progress-steps">
                        <div class="step active">🔍 检测 Local Adapter...</div>
                        <div class="step">🔗 建立本地连接...</div>
                        <div class="step">✅ 连接成功！</div>
                    </div>
                    <div class="terminal-preview">
                        <div class="terminal-header">
                            <span class="terminal-title">Mac Terminal - Connected</span>
                        </div>
                        <div class="terminal-content">
                            <div class="terminal-line">Last login: ${new Date().toLocaleString()}</div>
                            <div class="terminal-line">MacBook-Pro:~ user$ <span class="cursor">|</span></div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 连接Windows WSL
        function connectWSL() {
            addChatMessage('ai', `
                <div class="connection-progress">
                    <h4>🪟 正在连接 Windows WSL...</h4>
                    <div class="progress-steps">
                        <div class="step active">🔍 检测 WSL 环境...</div>
                        <div class="step">🔗 建立 Local Adapter 连接...</div>
                        <div class="step">✅ 连接成功！</div>
                    </div>
                    <div class="terminal-preview">
                        <div class="terminal-header">
                            <span class="terminal-title">Windows WSL - Ubuntu</span>
                        </div>
                        <div class="terminal-content">
                            <div class="terminal-line">Welcome to Ubuntu on Windows!</div>
                            <div class="terminal-line">user@DESKTOP-PC:~$ <span class="cursor">|</span></div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 连接Linux终端
        function connectLinuxTerminal() {
            addChatMessage('ai', `
                <div class="connection-progress">
                    <h4>🐧 正在连接 Linux Terminal...</h4>
                    <div class="progress-steps">
                        <div class="step active">🔍 检测本地环境...</div>
                        <div class="step">🔗 建立 Local Adapter 连接...</div>
                        <div class="step">✅ 连接成功！</div>
                    </div>
                    <div class="terminal-preview">
                        <div class="terminal-header">
                            <span class="terminal-title">Linux Terminal - Connected</span>
                        </div>
                        <div class="terminal-content">
                            <div class="terminal-line">Linux localhost 5.4.0-generic #1 SMP</div>
                            <div class="terminal-line">user@localhost:~$ <span class="cursor">|</span></div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 快速指令系统
        const supportedCommands = {
            '/deploy': '部署项目到生产环境',
            '/analyze': '代码质量分析和优化建议',
            '/init': '项目初始化和结构创建',
            '/help': '显示所有可用指令',
            '/test': '运行单元测试',
            '/build': '构建项目',
            '/create': '创建新文件',
            '/open': '打开指定文件',
            '/save': '保存当前文件',
            '/refactor': '智能重构建议',
            '/format': '代码格式化',
            '/preview': '预览项目'
        };
        
        function executeCommand() {
            const input = document.getElementById('commandInput');
            const command = input.value.trim();
            
            if (!command) return;
            
            // 清空输入框
            input.value = '';
            
            // 处理命令
            handleCommand(command);
        }
        
        function handleCommand(command) {
            const cmd = command.split(' ')[0];
            const args = command.split(' ').slice(1);
            
            if (!supportedCommands[cmd]) {
                addChatMessage('ai', `❌ <strong>未知指令: ${cmd}</strong><br>输入 /help 查看所有可用指令`);
                return;
            }
            
            // 执行对应指令
            switch(cmd) {
                case '/help':
                    showHelpMessage();
                    break;
                case '/deploy':
                    executeDeployCommand();
                    break;
                case '/analyze':
                    executeAnalyzeCommand();
                    break;
                case '/init':
                    executeInitCommand();
                    break;
                case '/test':
                    executeTestCommand();
                    break;
                case '/build':
                    executeBuildCommand();
                    break;
                case '/save':
                    saveFile();
                    break;
                case '/format':
                    executeFormatCommand();
                    break;
                default:
                    addChatMessage('ai', `🔧 <strong>执行指令: ${cmd}</strong><br>${supportedCommands[cmd]}<br>✅ 指令执行完成`);
            }
        }
        
        function showHelpMessage() {
            let helpText = '📋 <strong>快速指令帮助</strong><br><br>';
            helpText += '<strong>📁 文件操作指令:</strong><br>';
            helpText += '• /init - 生成项目初始化文档<br>';
            helpText += '• /create &lt;filename&gt; - 创建新文件<br>';
            helpText += '• /open &lt;filename&gt; - 打开指定文件<br>';
            helpText += '• /save - 保存当前编辑文件<br><br>';
            
            helpText += '<strong>🔧 开发工具指令:</strong><br>';
            helpText += '• /analyze - 生成代码分析报告<br>';
            helpText += '• /refactor - 智能重构建议<br>';
            helpText += '• /test - 生成单元测试文件<br>';
            helpText += '• /format - 代码格式化<br><br>';
            
            helpText += '<strong>🚀 部署相关指令:</strong><br>';
            helpText += '• /deploy - 智能部署功能<br>';
            helpText += '• /build - 构建项目<br>';
            helpText += '• /preview - 预览项目<br><br>';
            
            helpText += '<strong>📊 系统指令:</strong><br>';
            helpText += '• /help - 显示所有可用指令';
            
            addChatMessage('ai', helpText);
        }
        
        function executeDeployCommand() {
            addChatMessage('ai', '🚀 <strong>开始部署流程</strong><br>正在检测项目类型...<br>✅ 检测到前端项目<br>📦 正在构建...<br>🌐 正在部署到生产环境...<br>✅ 部署完成！');
        }
        
        function executeAnalyzeCommand() {
            addChatMessage('ai', '📊 <strong>代码分析报告</strong><br><br><strong>质量评分:</strong> 85/100<br><strong>复杂度:</strong> 中等<br><strong>可维护性:</strong> 良好<br><br><strong>建议:</strong><br>• 减少函数复杂度<br>• 增加注释覆盖率<br>• 优化性能瓶颈');
        }
        
        function executeInitCommand() {
            addChatMessage('ai', '🔧 <strong>项目初始化</strong><br>正在创建项目结构...<br>📁 创建目录结构<br>📄 生成配置文件<br>📋 创建README.md<br>✅ 项目初始化完成！');
        }
        
        function executeTestCommand() {
            addChatMessage('ai', '🧪 <strong>运行单元测试</strong><br>正在执行测试套件...<br>✅ 测试通过: 15/15<br>📊 代码覆盖率: 92%<br>⏱️ 执行时间: 2.3s');
        }
        
        function executeBuildCommand() {
            addChatMessage('ai', '📦 <strong>构建项目</strong><br>正在编译源代码...<br>🔧 优化资源文件...<br>📦 生成构建产物...<br>✅ 构建完成！');
        }
        
        function executeFormatCommand() {
            if (monacoEditor && currentFile) {
                // 触发Monaco Editor的格式化
                monacoEditor.getAction('editor.action.formatDocument').run();
                addChatMessage('ai', `🎨 <strong>代码格式化完成</strong><br>文件: ${currentFile.name}<br>✅ 代码已按照标准格式化`);
            } else {
                addChatMessage('ai', '❌ 请先打开一个文件再进行格式化');
            }
        }
        
        function handleCommandKeyPress(event) {
            if (event.key === 'Enter') {
                executeCommand();
            }
        }
        
        // 工作流选择
        function selectWorkflow(workflow) {
            // 更新选中状态
            document.querySelectorAll('.workflow-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.workflow-item').classList.add('active');
            
            const workflowNames = {
                'analyze': '代码分析',
                'refactor': '自动重构',
                'test': '单元测试',
                'build': '构建部署',
                'optimize': '性能优化',
                'monitor': '监控运维'
            };
            
            addChatMessage('ai', `🎯 <strong>选择工作流: ${workflowNames[workflow]}</strong><br>正在启动工作流程...<br>✅ 工作流已激活`);
        }
        
        // 聊天功能
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 添加用户消息
            addChatMessage('user', message);
            
            // 清空输入框
            input.value = '';
            
            // 检查是否是指令
            if (message.startsWith('/')) {
                handleCommand(message);
            } else {
                // 模拟AI回复
                setTimeout(() => {
                    addChatMessage('ai', `🤖 收到您的消息: "${message}"<br><br>我是ClaudeEditor v4.7.3 AI助手，可以帮您：<br>• 执行快速指令<br>• 代码分析和优化<br>• 项目管理<br>• 部署协助<br><br>试试输入快速指令，如 /help 查看所有功能！`);
                }, 500);
            }
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function addChatMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 更新Token統計
        function updateTokenSavings(amount) {
            tokenStats.saved += amount;
            tokenStats.total += amount;
            
            // 更新UI顯示
            const savedElement = document.querySelector('.token-value');
            savedElement.textContent = tokenStats.saved.toLocaleString();
            
            const totalElement = document.querySelectorAll('.token-value')[1];
            totalElement.textContent = tokenStats.total.toLocaleString();
            
            // 更新節省率
            const rate = (tokenStats.saved / tokenStats.total * 100).toFixed(1);
            document.querySelector('.efficiency-rate').textContent = rate + '%';
        }
        
        // 更新權限顯示
        function updatePermissionDisplay(level) {
            currentUserPermission = level;
            const permissionElement = document.getElementById('userPermissionLevel');
            permissionElement.textContent = level.charAt(0).toUpperCase() + level.slice(1);
            permissionElement.className = `permission-level ${level}`;
            
            // 根據權限級別調整UI
            applyPermissionRestrictions(level);
        }
        
        // 應用權限限制
        function applyPermissionRestrictions(level) {
            if (level === 'user') {
                // 用戶級別限制
                document.querySelectorAll('.workflow-item').forEach((item, index) => {
                    if (index > 1) { // 只允許前兩個工作流
                        item.style.opacity = '0.5';
                        item.style.pointerEvents = 'none';
                        item.title = '需要開發者權限';
                    }
                });
                // 禁用SmartUI相關功能
                document.querySelectorAll('.smartui-feature').forEach(item => {
                    item.style.display = 'none';
                });
            } else if (level === 'developer') {
                // 開發者級別
                document.querySelectorAll('.workflow-item').forEach(item => {
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                    item.title = '';
                });
                // 顯示SmartUI功能
                document.querySelectorAll('.smartui-feature').forEach(item => {
                    item.style.display = '';
                });
            } else if (level === 'admin') {
                // 管理員級別 - 完全訪問
                document.querySelectorAll('.workflow-item').forEach(item => {
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                });
                // 顯示所有功能
                document.querySelectorAll('.admin-feature').forEach(item => {
                    item.style.display = '';
                });
            }
        }
        
        // 更新GitHub狀態
        function updateGitHubStatus(branch, commits, syncStatus) {
            document.querySelector('.branch-name').textContent = branch;
            document.querySelector('.commit-count').textContent = `${commits} commits`;
            document.querySelector('.sync-status').textContent = syncStatus ? '✅ 已同步' : '⚠️ 未同步';
        }
        
        // SmartUI 集成準備
        function initSmartUIIntegration() {
            console.log('準備SmartUI MCP集成...');
            
            // SmartUI MCP集成接口
            window.smartUI = {
                // 生成UI組件
                async generateUI(type, config) {
                    try {
                        // 模擬調用SmartUI MCP
                        console.log(`生成${type}類型UI...`);
                        
                        // 實際應調用: await window.mcp.call('smartui_mcp', 'generate_ui', {...})
                        const mockResult = {
                            status: 'success',
                            code: `<div class="smartui-generated">SmartUI生成的${type}組件</div>`
                        };
                        
                        return mockResult;
                    } catch (error) {
                        console.error('SmartUI生成失敗:', error);
                        return { status: 'error', message: error.message };
                    }
                },
                
                // 在指定位置注入UI
                injectUI(html, targetSelector) {
                    const target = document.querySelector(targetSelector);
                    if (target) {
                        const container = document.createElement('div');
                        container.className = 'smartui-container';
                        container.innerHTML = html;
                        target.appendChild(container);
                        console.log('✅ SmartUI已注入');
                    }
                },
                
                // 權限檢查
                checkPermission(feature) {
                    if (currentUserPermission === 'user' && feature === 'generate') {
                        return false;
                    }
                    return true;
                }
            };
            
            window.smartUIReady = true;
            console.log('✅ SmartUI MCP接口已準備');
        }
        
        // StageWise 測試集成準備
        function initStageWiseIntegration() {
            console.log('準備StageWise MCP集成...');
            // 這裡預留StageWise MCP的集成接口
            window.stageWiseReady = true;
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ClaudeEditor v4.7.3 初始化中...');
            
            // 🔗 强制检查core依赖 - 这是强绑定的关键
            console.log('🔍 检查Core依赖...');
            const coreCheck = await window.coreDependencyChecker.checkCoreAvailability();
            
            if (coreCheck.status === 'error') {
                console.error('❌ Core依赖检查失败:', coreCheck.message);
                window.coreDependencyChecker.showCoreError(coreCheck);
                return; // 停止初始化，强制用户修复core依赖
            }
            
            console.log('✅ Core依赖检查通过:', coreCheck.message);
            console.log('📦 Core版本:', coreCheck.coreVersion);
            
            // 绑定按钮事件 - 确保按钮能正常工作
            const openFolderBtn = document.getElementById('openFolderBtn');
            const cloneRepoBtn = document.getElementById('cloneRepoBtn');
            const connectRemoteBtn = document.getElementById('connectRemoteBtn');
            const connectLocalBtn = document.getElementById('connectLocalBtn');
            
            if (openFolderBtn) {
                openFolderBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('打开文件夹按钮被点击');
                    openFolder();
                });
            }
            
            if (cloneRepoBtn) {
                cloneRepoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('克隆Git仓库按钮被点击');
                    cloneRepository();
                });
            }
            
            if (connectRemoteBtn) {
                connectRemoteBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('连接远程主机按钮被点击');
                    connectRemote();
                });
            }
            
            if (connectLocalBtn) {
                connectLocalBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('连接本地终端按钮被点击');
                    connectLocalTerminal();
                });
            }
            
            // 初始化權限系統
            updatePermissionDisplay('developer'); // 默認開發者權限
            
            // 初始化GitHub狀態
            updateGitHubStatus('main', 42, true);
            
            // 準備SmartUI和StageWise集成
            initSmartUIIntegration();
            initStageWiseIntegration();
            
            // 延迟初始化Monaco Editor，确保DOM完全加载
            setTimeout(() => {
                initMonacoEditor();
            }, 500);
            
            console.log('✅ ClaudeEditor v4.7.3 初始化完成');
            console.log('✅ 權限系統已啟用');
            console.log('✅ SmartUI/StageWise MCP準備就緒');
        });
        
        // 窗口大小改变时重新调整编辑器
        window.addEventListener('resize', function() {
            if (monacoEditor) {
                monacoEditor.layout();
            }
        });
        
        // PowerAutomation集成橋接
        class ClaudeEditorPowerAutomationBridge {
            constructor() {
                this.mcp = window.mcp || {};
                this.smartUI = window.smartUI || {};
                this.permissions = currentUserPermission || 'developer';
            }
            
            async initialize() {
                console.log('🚀 初始化ClaudeEditor-PowerAutomation橋接');
                
                // 註冊MCP處理器
                this.registerMCPHandlers();
                
                // 設置SmartUI增強規則
                this.setupSmartUIEnhancements();
                
                // 保持原有功能，添加MCP集成
                this.enhanceExistingFeatures();
                
                console.log('✅ PowerAutomation橋接初始化完成');
            }
            
            registerMCPHandlers() {
                // 增強模型切換功能
                const originalSwitchModel = window.switchModel;
                window.switchModel = async (model) => {
                    // 調用原始功能
                    if (originalSwitchModel) {
                        originalSwitchModel.call(window, model);
                    }
                    
                    // 添加MCP調用
                    try {
                        const result = await this.callMCP('router_mcp', 'route', {
                            target_model: model,
                            user_permission: this.permissions
                        });
                        console.log('✅ Router MCP響應:', result);
                    } catch (error) {
                        console.error('Router MCP調用失敗:', error);
                    }
                };
                
                // 增強工作流功能
                const originalSelectWorkflow = window.selectWorkflow;
                window.selectWorkflow = async (workflow) => {
                    if (originalSelectWorkflow) {
                        originalSelectWorkflow.call(window, workflow);
                    }
                    
                    try {
                        const result = await this.callMCP('workflow_mcp', 'execute', {
                            workflow_type: workflow,
                            context: this.getContext()
                        });
                        console.log('✅ Workflow MCP響應:', result);
                    } catch (error) {
                        console.error('Workflow MCP調用失敗:', error);
                    }
                };
            }
            
            setupSmartUIEnhancements() {
                // SmartUI增強規則 - 不破壞原有UI
                this.smartUI.enhance = async (targetSelector, enhancement) => {
                    const target = document.querySelector(targetSelector);
                    if (!target) return;
                    
                    // 檢查權限
                    if (!this.checkPermission(enhancement.requiredPermission)) {
                        console.log('權限不足，跳過增強:', enhancement.name);
                        return;
                    }
                    
                    // 創建增強容器，不修改原有結構
                    const enhanceContainer = document.createElement('div');
                    enhanceContainer.className = 'smartui-enhancement';
                    enhanceContainer.innerHTML = enhancement.html;
                    
                    // 添加到目標元素內部末尾
                    target.appendChild(enhanceContainer);
                    
                    console.log('✅ SmartUI增強已應用:', enhancement.name);
                };
            }
            
            enhanceExistingFeatures() {
                // 為AI控制面板添加實時統計
                this.smartUI.enhance('.ai-control-section', {
                    name: 'real-time-stats',
                    requiredPermission: 'developer',
                    html: `
                        <div class="mcp-stats" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <div style="font-size: 12px; opacity: 0.9;">MCP狀態</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>Router: <span style="color: #4ade80;">✓</span></span>
                                <span>K2 Chat: <span style="color: #4ade80;">✓</span></span>
                                <span>SmartUI: <span style="color: #4ade80;">✓</span></span>
                            </div>
                        </div>
                    `
                });
                
                // 為工作流添加進度顯示
                document.querySelectorAll('.workflow-item').forEach((item, index) => {
                    // 添加數據屬性但不改變外觀
                    item.setAttribute('data-mcp-enabled', 'true');
                    item.setAttribute('data-workflow-id', ['analyze', 'refactor', 'test', 'build', 'optimize', 'monitor'][index]);
                });
            }
            
            async callMCP(component, method, params) {
                // 模擬MCP調用（實際環境中應調用真實API）
                console.log(`調用MCP: ${component}.${method}`, params);
                
                // 返回模擬結果
                return {
                    status: 'success',
                    component: component,
                    method: method,
                    result: {
                        message: `${component}處理成功`,
                        timestamp: new Date().toISOString()
                    }
                };
            }
            
            checkPermission(required) {
                const permissionLevels = { user: 1, developer: 2, admin: 3 };
                const currentLevel = permissionLevels[this.permissions] || 1;
                const requiredLevel = permissionLevels[required] || 1;
                return currentLevel >= requiredLevel;
            }
            
            getContext() {
                return {
                    user_permission: this.permissions,
                    current_file: currentFile,
                    editor_content: monacoEditor?.getValue() || '',
                    screen_size: window.innerWidth,
                    current_mode: currentMode
                };
            }
        }
        
        // 延遲初始化PowerAutomation橋接，確保所有組件都已加載
        setTimeout(() => {
            window.powerAutomationBridge = new ClaudeEditorPowerAutomationBridge();
            window.powerAutomationBridge.initialize();
        }, 1000);
    </script>
</body>
</html>

